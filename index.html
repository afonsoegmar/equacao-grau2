<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atividade Equação de 2º Grau</title>
    <!-- Carregamento do Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de estilo do Tailwind para o tema -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Habilita o modo escuro via classe 'dark'
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6', // blue-500
                        secondary: '#ef4444', // red-500
                        background: 'var(--bg)',
                        text: 'var(--text)',
                        card: 'var(--card)',
                    }
                }
            }
        }
    </script>
    <!-- Estilos customizados para o modo claro/escuro, scrollbar E VÍDEO DE FUNDO -->
    <style>
        /* TEMA CLARO */
        :root {
            --bg: #f8fafc; /* slate-50 */
            --text: #0f172a; /* slate-900 */
            --card: #ffffff;
        }
        /* TEMA ESCURO (Otimizado para vídeo de estrelas/fundo preto) */
        .dark {
            --bg: #0a0e1a; /* Azul muito escuro, quase preto (fundo) */
            --text: #e2e8f0; /* slate-200 (texto) */
            --card: #161e2f; /* Dark card background (levemente mais claro que o fundo) */
        }
        body {
            transition: background-color 0.3s, color 0.3s;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            /* Garante que o body não tenha margem */
            margin: 0;
        }
        
        /* Aplica uma leve transparência aos cartões no modo escuro */
        .bg-card {
            background-color: var(--card); /* Cor base */
            transition: background-color 0.3s, opacity 0.3s, backdrop-filter 0.3s;
        }
        /* Mantém a opacidade de 95% para os cartões de CONTEÚDO (que não são o header) */
        .dark .bg-card {
            background-color: var(--card); 
            opacity: 0.95; 
        }
        
        /* ESTILO: HEADER FIXO */
        #main-header {
            position: fixed; 
            top: 0;
            left: 0;
            right: 0;
            z-index: 50; 
            /* CRUCIAL: Adiciona position: relative para que o vídeo de fundo interno funcione */
            position: relative; 
        }
        
        /* COMPENSAÇÃO: Adiciona padding ao conteúdo principal para que o header fixo não o cubra */
        #app {
            padding-top: 140px; /* Ajuste este valor se o header mudar de altura (aprox. altura do header + margem) */
            min-height: 100vh;
        }
        
        /* Resto dos estilos */
        .scroll-container::-webkit-scrollbar { width: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 4px; }
        .dark .scroll-container::-webkit-scrollbar-thumb { background-color: #475569; }
        .custom-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); }

        /* ESTILOS PARA O VÍDEO DE FUNDO DA PÁGINA (Full Screen) */
        #background-video {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -10; /* O mais fundo de todos */
            object-fit: cover;
            opacity: 0.25; /* Opacidade suave (Modo Claro - um pouco mais visível) */
            transition: opacity 0.3s;
        }
        /* Aumenta a opacidade do vídeo da página no modo escuro */
        .dark #background-video {
            opacity: 0.40; 
        }
        
        /* ESTILOS PARA O VÍDEO DE FUNDO DO HEADER */
        #header-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 10; /* Fica acima do vídeo da página, mas abaixo do conteúdo do header (z-20) */
            opacity: 0.7; /* Suaviza a cor para não competir com o texto */
            transition: opacity 0.3s;
        }
        
    </style>
    <!-- Carregamento de Bibliotecas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="min-h-screen p-0 transition-colors duration-300">
    
    <!-- VÍDEO DE FUNDO DA PÁGINA (FULL SCREEN) - Nível Z: -10 -->
    <video autoplay loop muted playsinline id="background-video" class="transition-opacity duration-500">
        <source src="galaxy.mp4" type="video/mp4">
        Seu navegador não suporta a tag de vídeo.
    </video>
    <!-- FIM DO VÍDEO DE FUNDO DA PÁGINA -->

    <!-- CABEÇALHO/HERO SECTION (FIXO) - Nível Z: 50 -->
    <!-- ALTERADO: REMOVIDO p-6 md:p-8, ADICIONADO py-6 md:py-8 para manter a altura vertical -->
    <header id="main-header" class="overflow-hidden py-6 md:py-8 
        bg-white/10 dark:bg-slate-900/40 backdrop-blur-md 
        rounded-b-xl custom-shadow 
        flex flex-col transition-colors duration-300 text-center
        mb-0"> 
        
        <!-- VÍDEO DE FUNDO DO CABEÇALHO - Nível Z: 10 (dentro do header) -->
        <video autoplay loop muted playsinline id="header-video" class="transition-opacity duration-500">
            <source src="blackhole.mp4" type="video/mp4">
            Seu navegador não suporta a tag de vídeo.
        </video>
        <!-- FIM DO VÍDEO DE FUNDO DO CABEÇALHO -->

        <!-- CONTEÚDO PRINCIPAL DO HEADER - Nível Z: 20 (dentro do header, acima do vídeo interno) -->
        <div class="relative z-20 w-full"> 
            <!-- ALTERADO: REMOVIDO max-w-7xl mx-auto (centralização), ADICIONADO px-4 md:px-8 (alinhamento lateral) -->
            <div class="flex flex-col md:flex-row justify-between items-center transition-colors duration-300 px-4 md:px-8 w-full">
                
                <!-- BLOCO DO LOGO E TÍTULO -->
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <!-- LOGO (IMAGEM PNG) - JÁ ESTÁ w-16 h-16 -->
                    <img id="app-logo" 
                         src="egteck.png" 
                         alt="Logo da Atividade" 
                         class="w-16 h-16 rounded-full ring-2 ring-white/80 dark:ring-slate-200/50 object-cover custom-shadow"
                         onerror="this.onerror=null;this.src='https://placehold.co/64x64/60a5fa/ffffff?text=Logo'">
                    
                    <div class="text-left">
                        <h1 class="text-4xl font-extrabold text-primary">ATIVIDADE: EQUAÇÃO DE SEGUNDO GRAU</h1>
                        <p class="text-sm mt-2 opacity-90 text-text">
                            Desenvolvedor: [Seu Nome Aqui] | <span class="font-bold text-secondary">Histórico Local</span>
                        </p>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-4 md:mt-0">
                    
                    <!-- BOTÃO README -->
                    <a href="README.md" target="_blank" class="p-2 px-4 rounded-full bg-green-500 text-white font-semibold hover:bg-green-600 transition-all flex items-center space-x-2 custom-shadow" aria-label="Ver Documentação (README)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="hidden sm:inline">README</span>
                    </a>

                    <!-- BOTÃO ALTERNAR TEMA -->
                    <button id="theme-toggle" class="p-2 rounded-full text-text bg-gray-100 dark:bg-slate-700 hover:opacity-80 transition-all custom-shadow" aria-label="Alternar tema">
                        <svg id="sun-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>
    <!-- FIM DO HEADER FIXO -->

    <!-- CONTEÚDO PRINCIPAL (COM PADDING SUPERIOR DE COMPENSAÇÃO E MARGEM INFERIOR) -->
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8 mb-6"> <!-- A classe mb-6 adiciona margem após todo o conteúdo -->
        
        <!-- LAYOUT PRINCIPAL RESPONSIVO -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUNA DE ENTRADA E RESULTADOS (LARGURA: 1 ou 2) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- CARD DE ENTRADA -->
                <div class="p-6 bg-card rounded-xl custom-shadow transition-colors duration-300">
                    <h2 class="text-2xl font-bold mb-4">Insira os Coeficientes (ax² + bx + c = 0)</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="a-input" class="block text-sm font-medium mb-1">Coeficiente 'a' (≠ 0)</label>
                            <input type="number" id="a-input" value="1" step="any" class="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-800 text-text focus:ring-primary focus:border-primary transition duration-150">
                        </div>
                        <div>
                            <label for="b-input" class="block text-sm font-medium mb-1">Coeficiente 'b'</label>
                            <input type="number" id="b-input" value="-3" step="any" class="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-800 text-text focus:ring-primary focus:border-primary transition duration-150">
                        </div>
                        <div>
                            <label for="c-input" class="block text-sm font-medium mb-1">Coeficiente 'c'</label>
                            <input type="number" id="c-input" value="2" step="any" class="w-full p-3 border border-gray-300 dark:border-slate-600 rounded-lg bg-gray-50 dark:bg-slate-800 text-text focus:ring-primary focus:border-primary transition duration-150">
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <button id="calculate-btn" class="flex-1 p-3 bg-primary text-white font-semibold rounded-lg hover:bg-blue-800 transition duration-150 custom-shadow">
                            Calcular Raízes e Gerar Gráfico
                        </button>
                        <button id="voice-input-btn" class="w-full sm:w-auto p-3 bg-secondary text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 custom-shadow flex items-center justify-center space-x-2" title="Entrada de Voz (Experimental)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7v0m0-14a7 7 0 017 7v0m0 0v0a3 3 0 00-6 0v0m-3.9 3.9l-2.1 2.1m4.2 4.2l2.1 2.1M10 21v-2"></path></svg>
                            <span id="voice-btn-text">Entrada por Voz</span>
                        </button>
                    </div>
                    <p class="text-xs text-center mt-3 opacity-70">Diga, por exemplo: "A igual a cinco, B igual a menos três ponto dois, C igual a dez".</p>
                </div>

                <!-- CARD DE RESULTADOS E GRÁFICO -->
                <div class="p-6 bg-card rounded-xl custom-shadow transition-colors duration-300">
                    <h2 class="text-2xl font-bold mb-4">Análise e Gráfico da Equação</h2>
                    
                    <div id="results" class="mb-4 p-4 rounded-lg border border-gray-200 dark:border-slate-600">
                        <p class="font-semibold text-lg mb-2">Equação: <span id="equation-display" class="font-mono text-lg">...</span></p>
                        <p>Delta ($\Delta$): <span id="delta-display" class="font-mono font-bold text-lg">...</span></p>
                        <p>Raízes (<span id="roots-label">x' e x''</span>): <span id="roots-display" class="font-mono font-bold text-lg">...</span></p>
                    </div>

                    <!-- Mensagem de Feedback Educacional -->
                    <div id="educational-feedback" class="hidden p-4 mt-4 bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-100 rounded-lg border-l-4 border-yellow-500">
                        <!-- Conteúdo de feedback dinâmico -->
                    </div>
                    
                    <!-- Área do Gráfico -->
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold mb-3">Gráfico da Parábola</h3>
                        <div class="relative w-full h-80 bg-gray-50 dark:bg-slate-800 rounded-lg p-2 border border-gray-300 dark:border-slate-600">
                            <canvas id="parabolaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUNA DE HISTÓRICO E QR CODE (LARGURA: 1) -->
            <div class="lg:col-span-1 space-y-6">

                <!-- CARD DE HISTÓRICO -->
                <div class="p-6 bg-card rounded-xl custom-shadow transition-colors duration-300">
                    <h2 class="text-2xl font-bold mb-4">Histórico de Soluções</h2>
                    <div id="history-list" class="scroll-container h-64 overflow-y-auto space-y-3 p-2 rounded-lg bg-gray-50 dark:bg-slate-800">
                        <p id="history-placeholder" class="text-gray-500 dark:text-gray-400">O histórico será carregado e atualizado aqui.</p>
                    </div>
                </div>
                
                <!-- CARD DE QR CODE -->
                <div class="p-6 bg-card rounded-xl custom-shadow transition-colors duration-300">
                    <h2 class="text-2xl font-bold mb-4">Acesso Móvel (QR Code)</h2>
                    <p class="text-sm mb-3 opacity-75">Escaneie para abrir o projeto no seu celular:</p>
                    <div id="qrcode-container" class="p-4 bg-white rounded-lg flex justify-center items-center">
                        <div id="qrcode" class="w-40 h-40"></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- MODAL DE MENSAGEM (Custom Alert) -->
        <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300" onclick="hideMessage()">
            <div class="bg-card rounded-xl p-6 w-full max-w-md custom-shadow transition-all duration-300" onclick="event.stopPropagation()">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-primary">Atenção</h3>
                <p id="modal-content" class="mb-4 text-text"></p>
                <button onclick="hideMessage()" class="w-full p-3 bg-primary text-white font-semibold rounded-lg hover:bg-blue-800 transition duration-150">
                    Entendi
                </button>
            </div>
        </div>
        
    </div>

    <script type="text/javascript">
        // ====================================================================
        // VARIÁVEIS GLOBAIS
        // ====================================================================
        let parabolaChart;
        let isDarkMode = false;
        // Chave para armazenar o histórico no localStorage
        const LOCAL_STORAGE_KEY = 'quadratic_equation_history';

        // Elementos UI
        const elements = {
            a: document.getElementById('a-input'),
            b: document.getElementById('b-input'), 
            c: document.getElementById('c-input'),
            calculateBtn: document.getElementById('calculate-btn'),
            deltaDisplay: document.getElementById('delta-display'),
            rootsDisplay: document.getElementById('roots-display'),
            equationDisplay: document.getElementById('equation-display'),
            rootsLabel: document.getElementById('roots-label'),
            historyList: document.getElementById('history-list'),
            historyPlaceholder: document.getElementById('history-placeholder'),
            // userIdDisplay: Removido, pois não é necessário para localStorage
            feedback: document.getElementById('educational-feedback'),
            themeToggle: document.getElementById('theme-toggle'),
            sunIcon: document.getElementById('sun-icon'),
            moonIcon: document.getElementById('moon-icon'),
            voiceBtn: document.getElementById('voice-input-btn'),
            voiceBtnText: document.getElementById('voice-btn-text'),
            modal: document.getElementById('message-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
        };

        // ====================================================================
        // FUNÇÕES DE UTILIDADE E UI
        // ====================================================================

        /**
         * Exibe um modal de mensagem customizado (substituindo o alert).
         * @param {string} title Título do modal.
         * @param {string} message Conteúdo da mensagem.
         * @param {string} type Tipo: 'error' (padrão) ou 'info'.
         */
        function showMessage(title, message, type = 'error') {
            if (type === 'error') {
                elements.modalTitle.textContent = title;
                elements.modalTitle.classList.remove('text-primary');
                elements.modalTitle.classList.add('text-secondary');
            } else {
                elements.modalTitle.textContent = title;
                elements.modalTitle.classList.remove('text-secondary');
                elements.modalTitle.classList.add('text-primary');
            }
            elements.modalContent.textContent = message;
            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');
        }

        /** Oculta o modal de mensagem. */
        function hideMessage() {
            elements.modal.classList.remove('flex');
            elements.modal.classList.add('hidden');
        }

        /** Alterna o modo claro/escuro. */
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                elements.sunIcon.classList.add('hidden');
                elements.moonIcon.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                elements.sunIcon.classList.remove('hidden');
                elements.moonIcon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
            // Atualiza o gráfico após a mudança de tema
            if (parabolaChart) {
                plotParabola(
                    parseFloat(elements.a.value),
                    parseFloat(elements.b.value),
                    parseFloat(elements.c.value)
                );
            }
        }

        /** Inicializa o tema baseado na preferência salva ou no sistema. */
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPreference = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && systemPreference)) {
                isDarkMode = false; // Será invertido por toggleTheme
                toggleTheme();
            } else {
                isDarkMode = true; // Será invertido por toggleTheme
                toggleTheme();
            }
            elements.themeToggle.addEventListener('click', toggleTheme);
        }

        // ====================================================================
        // LOCAL STORAGE (HISTÓRICO)
        // ====================================================================

        /**
         * Carrega o histórico de equações do localStorage.
         * @returns {Array<Object>} Lista de equações resolvidas.
         */
        function loadHistory() {
            try {
                const historyJson = localStorage.getItem(LOCAL_STORAGE_KEY);
                return historyJson ? JSON.parse(historyJson) : [];
            } catch (error) {
                console.error("Erro ao carregar histórico do localStorage:", error);
                return [];
            }
        }

        /**
         * Salva uma equação resolvida no localStorage e atualiza a UI.
         * @param {number} a Coeficiente a.
         * @param {number} b Coeficiente b.
         * @param {number} c Coeficiente c.
         * @param {number} delta Valor de Delta.
         * @param {string} roots Raízes calculadas.
         */
        function saveEquationToLocalStorage(a, b, c, delta, roots) {
            const history = loadHistory();
            const newEntry = {
                a, b, c, delta, roots,
                // Adiciona um timestamp simples para ordenação
                timestamp: Date.now() 
            };
            
            // Adiciona o novo item e limita o tamanho do histórico a 20 entradas (opcional)
            history.unshift(newEntry);
            if (history.length > 20) {
                history.pop();
            }

            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(history));
                console.log("Equação salva no localStorage com sucesso.");
            } catch (error) {
                console.error("Erro ao salvar no localStorage:", error);
            }

            renderHistory(history); // Renderiza imediatamente após salvar
        }

        /**
         * Renderiza o histórico de equações na UI.
         * @param {Array<Object>} history Dados do histórico.
         */
        function renderHistory(history) {
            elements.historyList.innerHTML = '';
            
            if (history.length === 0) {
                elements.historyList.appendChild(elements.historyPlaceholder);
                elements.historyPlaceholder.textContent = "Nenhum histórico encontrado. Resolva uma equação!";
                elements.historyPlaceholder.classList.remove('hidden');
                return;
            }

            elements.historyPlaceholder.classList.add('hidden');
            
            // Ordena do mais recente para o mais antigo (baseado no timestamp local)
            history.sort((a, b) => b.timestamp - a.timestamp);

            history.forEach(item => {
                const date = item.timestamp ? new Date(item.timestamp).toLocaleTimeString('pt-BR') : 'Sem data';
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 rounded-lg border border-gray-200 dark:border-slate-700 bg-card hover:bg-gray-100 dark:hover:bg-slate-600 transition duration-150 cursor-pointer';
                itemEl.innerHTML = `
                    <p class="font-semibold text-sm break-all">Eq: ${item.a}x² ${item.b < 0 ? item.b : '+' + item.b}x ${item.c < 0 ? item.c : '+' + item.c} = 0</p>
                    <p class="text-xs mt-1">Δ: ${item.delta}</p>
                    <p class="text-xs">Raízes: ${item.roots}</p>
                    <p class="text-[10px] text-right opacity-60">${date}</p>
                `;
                itemEl.onclick = () => {
                    // Preenche os campos de input com a equação do histórico
                    elements.a.value = item.a;
                    elements.b.value = item.b;
                    elements.c.value = item.c;
                    calculateAndPlot();
                };
                elements.historyList.appendChild(itemEl);
            });
        }

        /** Inicia o carregamento do histórico do localStorage. */
        function setupHistoryListener() {
            const initialHistory = loadHistory();
            renderHistory(initialHistory);
        }

        // ====================================================================
        // GRÁFICO (CHART.JS)
        // ====================================================================

        /**
         * Cria os pontos da parábola para o gráfico.
         * @param {number} a Coeficiente a.
         * @param {number} b Coeficiente b.
         * @param {number} c Coeficiente c.
         * @param {number} roots Raízes da equação (se existirem).
         * @returns {Object} Dados para o Chart.js.
         */
        function createParabolaData(a, b, c, roots = []) {
            const dataPoints = [];
            let minX, maxX;

            // Determina a faixa de X para melhor visualização
            const xV = -b / (2 * a);
            
            // Ajusta o range para incluir o vértice e as raízes
            let xValues = [xV];
            roots.filter(r => isFinite(r)).forEach(r => xValues.push(r));

            if (xValues.length > 0) {
                const minVal = Math.min(...xValues);
                const maxVal = Math.max(...xValues);
                // Garante que o intervalo centralize o vértice/raízes, mas com uma margem de 5 unidades.
                let padding = Math.max(5, (maxVal - minVal) * 0.2); 
                minX = Math.min(minVal, xV) - padding;
                maxX = Math.max(maxVal, xV) + padding;
            } else {
                // Se não houver raízes (delta < 0), centra no vértice com um range padrão.
                minX = xV - 10;
                maxX = xV + 10;
            }

            // Garante um intervalo mínimo
            if (maxX - minX < 5) {
                const center = (maxX + minX) / 2;
                minX = center - 2.5;
                maxX = center + 2.5;
            }
            
            const step = (maxX - minX) / 100;

            for (let x = minX; x <= maxX; x += step) {
                const y = a * x * x + b * x + c;
                dataPoints.push({ x: x, y: y });
            }

            // Pontos das raízes para destacar
            const rootPoints = roots
                .filter(r => isFinite(r))
                .map(r => ({ x: r, y: 0, label: `Raiz ${r.toFixed(4)}` }));
            
            // Ponto do vértice (V)
            const yV = a * xV * xV + b * xV + c;
            const vertexPoint = { x: xV, y: yV, label: `Vértice (${xV.toFixed(4)}, ${yV.toFixed(4)})` };

            return { dataPoints, rootPoints, vertexPoint };
        }

        /**
         * Inicializa ou atualiza o gráfico da parábola.
         * @param {number} a Coeficiente a.
         * @param {number} b Coeficiente b.
         * @param {number} c Coeficiente c.
         * @param {number} roots Raízes da equação.
         */
        function plotParabola(a, b, c, roots = []) {
            const { dataPoints, rootPoints, vertexPoint } = createParabolaData(a, b, c, roots);
            const ctx = document.getElementById('parabolaChart').getContext('2d');
            
            // Cores baseadas no tema
            const axisColor = isDarkMode ? 'rgba(226, 232, 240, 0.7)' : 'rgba(15, 23, 42, 0.7)'; // slate-200 / slate-900
            const gridColor = isDarkMode ? 'rgba(226, 232, 240, 0.15)' : 'rgba(15, 23, 42, 0.1)';
            const textColor = isDarkMode ? '#e2e8f0' : '#0f172a';

            if (parabolaChart) {
                parabolaChart.destroy(); // Destrói o gráfico anterior
            }

            parabolaChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: `Parábola: y = ${a}x² ${b < 0 ? b : '+' + b}x ${c < 0 ? c : '+' + c}`,
                            data: dataPoints,
                            backgroundColor: 'rgba(59, 130, 246, 1)', // primary
                            borderColor: 'rgba(59, 130, 246, 0.8)',
                            borderWidth: 3,
                            showLine: true,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            fill: false,
                        },
                        {
                            label: 'Raízes (Eixo X)',
                            data: rootPoints,
                            backgroundColor: '#ef4444', // secondary (vermelho)
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false,
                        },
                        {
                            label: 'Vértice',
                            data: [vertexPoint],
                            backgroundColor: '#22c55e', // green-500
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: {
                        legend: { labels: { color: textColor } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (point.label) return point.label;
                                    return `(x: ${point.x.toFixed(4)}, y: ${point.y.toFixed(4)})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'Eixo X', color: textColor },
                            grid: { color: gridColor },
                            ticks: { color: axisColor }
                        },
                        y: {
                            title: { display: true, text: 'Eixo Y', color: textColor },
                            grid: { color: gridColor },
                            ticks: { color: axisColor }
                        }
                    }
                }
            });
        }


        // ====================================================================
        // LÓGICA DA EQUAÇÃO E VALIDAÇÃO
        // ====================================================================

        /**
         * Calcula o delta e as raízes da equação de 2º grau.
         */
        function calculateAndPlot() {
            const a = parseFloat(elements.a.value);
            const b = parseFloat(elements.b.value);
            const c = parseFloat(elements.c.value);

            elements.feedback.classList.add('hidden');
            elements.feedback.innerHTML = '';
            
            // 1. VALIDAÇÃO DE ENTRADA
            if (!isFinite(a) || !isFinite(b) || !isFinite(c)) {
                showMessage("Erro de Entrada", "Por favor, insira valores numéricos válidos para a, b e c.");
                return;
            }

            if (a === 0) {
                showMessage("Erro de Coeficiente 'a'", "O coeficiente 'a' não pode ser zero em uma equação de segundo grau. Se a=0, a equação é linear.");
                return;
            }

            // Exibir a equação no display
            const eqText = `${a}x² ${b < 0 ? b : '+' + b}x ${c < 0 ? c : '+' + c} = 0`;
            elements.equationDisplay.textContent = eqText;

            // 2. CÁLCULO DE DELTA
            const delta = b * b - 4 * a * c;
            elements.deltaDisplay.textContent = delta.toFixed(4);

            let rootsText = '';
            let roots = [];
            let feedbackContent = '';

            // 3. ANÁLISE DO DELTA E CÁLCULO DAS RAÍZES
            if (delta > 0) {
                // Duas raízes reais e distintas
                const x1 = (-b + Math.sqrt(delta)) / (2 * a);
                const x2 = (-b - Math.sqrt(delta)) / (2 * a);
                roots = [x1, x2];
                rootsText = `x' ≈ ${x1.toFixed(4)}, x'' ≈ ${x2.toFixed(4)}`;
                elements.rootsLabel.textContent = "x' e x''";
                feedbackContent = `O Delta ($\Delta$ = ${delta.toFixed(4)}) é positivo. Isso significa que a parábola intercepta o eixo X em DOIS pontos distintos (duas raízes reais).`;

            } else if (delta === 0) {
                // Uma raiz real (ou duas raízes reais e iguais)
                const x = -b / (2 * a);
                roots = [x];
                rootsText = `x' = x'' ≈ ${x.toFixed(4)}`;
                elements.rootsLabel.textContent = "x' = x''";
                feedbackContent = `O Delta ($\Delta$ = 0) é zero. Isso significa que a parábola TOCA o eixo X em um único ponto (duas raízes reais e iguais).`;

            } else {
                // Raízes complexas (Delta negativo)
                const realPart = -b / (2 * a);
                const imaginaryPart = Math.sqrt(-delta) / (2 * a);
                rootsText = `x' ≈ ${realPart.toFixed(4)} + ${imaginaryPart.toFixed(4)}i, x'' ≈ ${realPart.toFixed(4)} - ${imaginaryPart.toFixed(4)}i`;
                roots = []; // Raízes complexas não interceptam o eixo X real
                elements.rootsLabel.textContent = "x' e x'' (Complexas)";
                
                // Feedback educacional para raízes complexas
                feedbackContent = `
                    O Delta ($\Delta$ = ${delta.toFixed(4)}) é negativo.
                    Isso significa que a equação não possui raízes REAIS.
                    As raízes são NÚMEROS COMPLEXOS.
                    Visualmente, a parábola NÃO INTERCEPTA o eixo X, ficando totalmente acima ou abaixo dele.
                `;
            }

            elements.rootsDisplay.textContent = rootsText;
            
            // Exibir feedback
            elements.feedback.innerHTML = feedbackContent.replace(/\$/g, ''); // Remove $ para não confundir com o texto
            elements.feedback.classList.remove('hidden');

            // 4. GRÁFICO
            plotParabola(a, b, c, roots);

            // 5. SALVAR HISTÓRICO (USANDO LOCAL STORAGE)
            saveEquationToLocalStorage(a, b, c, delta.toFixed(4), rootsText);
        }

        // ====================================================================
        // SPEECH RECOGNITION (ENTRADA POR VOZ)
        // ====================================================================

        /** Configura e inicia o reconhecimento de voz. */
        function setupVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                elements.voiceBtn.disabled = true;
                elements.voiceBtn.classList.add('opacity-50', 'cursor-not-allowed');
                elements.voiceBtnText.textContent = 'Voz (Não Suportado)';
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            // Define o idioma para Português
            recognition.lang = 'pt-BR'; 
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                elements.voiceBtn.classList.remove('bg-secondary');
                elements.voiceBtn.classList.add('bg-orange-500', 'animate-pulse');
                elements.voiceBtnText.textContent = 'Ouvindo...';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                processVoiceTranscript(transcript);
            };

            recognition.onerror = (event) => {
                resetVoiceButton();
                console.error('Erro no reconhecimento de voz:', event.error);
                showMessage("Erro de Voz", `Ocorreu um erro: ${event.error}. Certifique-se de que seu microfone está conectado e as permissões foram concedidas. Tente novamente.`);
            };

            recognition.onend = () => {
                resetVoiceButton();
            };
            
            function resetVoiceButton() {
                elements.voiceBtn.classList.remove('bg-orange-500', 'animate-pulse');
                elements.voiceBtn.classList.add('bg-secondary');
                elements.voiceBtnText.textContent = 'Entrada por Voz';
            }

            elements.voiceBtn.addEventListener('click', () => {
                try {
                    recognition.start();
                } catch (e) {
                    // Ocorre se for clicado rapidamente ou já estiver ativo
                    console.error('Recognition already started or failed to start:', e);
                    showMessage("Erro de Voz", "O microfone pode já estar em uso ou falhou ao iniciar. Tente novamente em alguns segundos.");
                }
            });
        }

        /**
         * Processa a transcrição de voz para extrair os coeficientes.
         * Exemplo esperado: "A igual a 2, B igual a menos 3, C igual a 5.2"
         * @param {string} transcript Transcrição de voz em minúsculas.
         */
        function processVoiceTranscript(transcript) {
            console.log('Transcrição de Voz:', transcript);
            
            // Regex para capturar a letra do coeficiente (a, b, c) e o valor bruto (incluindo "menos" e "ponto/vírgula")
            const regex = /([abc])\s*(?:igual\s*a?)\s*([^abc,;]+)/g;
            let match;
            const values = {};

            while ((match = regex.exec(transcript)) !== null) {
                const key = match[1]; // Coeficiente: 'a', 'b', 'c'
                let rawValue = match[2].trim(); // Valor bruto: Ex: "menos 3" ou "5 ponto 2"

                // 1. Lida com o sinal negativo
                let sign = 1;
                if (rawValue.startsWith('menos')) {
                    sign = -1;
                    rawValue = rawValue.substring(5).trim();
                } else if (rawValue.startsWith('-')) {
                    sign = -1;
                    rawValue = rawValue.substring(1).trim();
                }
                
                // Remove espaços extras dentro do número e substitui vírgula por ponto
                rawValue = rawValue.replace(/\s/g, '').replace('vírgula', '.').replace('ponto', '.');

                // 2. Extrai o número (procura por dígitos e ponto decimal)
                const numberMatch = rawValue.match(/^-?\d+(\.\d+)?/);
                
                if (numberMatch) {
                    let numericValue = parseFloat(numberMatch[0]);
                    
                    if (sign === -1 && numericValue > 0) {
                        numericValue *= -1;
                    }

                    values[key] = numericValue;
                } else {
                    console.warn(`Não foi possível analisar o número do valor bruto: ${rawValue}`);
                }
            }

            let successfulUpdate = false;

            if (values.a !== undefined) { elements.a.value = values.a; successfulUpdate = true; }
            if (values.b !== undefined) { elements.b.value = values.b; successfulUpdate = true; }
            if (values.c !== undefined) { elements.c.value = values.c; successfulUpdate = true; }

            if (successfulUpdate) {
                showMessage("Entrada de Voz Sucesso", "Coeficientes atualizados! Pressione 'Calcular Raízes e Gerar Gráfico'.", 'info');
            } else {
                showMessage("Comando de Voz Inválido", "Não consegui entender os coeficientes. Certifique-se de usar a estrutura 'A igual a [número]', 'B igual a [número]', 'C igual a [número]'. Use a palavra 'menos' para números negativos e 'ponto' ou 'vírgula' para decimais.");
            }
        }

        // ====================================================================
        // QR CODE
        // ====================================================================

        /** Gera o QR Code com a URL de destino (GitHub Pages). */
        function generateQRCode() {
            // ====================================================================
            // INSTRUÇÃO CRÍTICA PARA O HOSTING NO GITHUB PAGES:
            //
            // 1. URL DE DESTINO FINAL (Obrigatório após o Deploy):
            //    APÓS HOSPEDAR NO GITHUB PAGES, SUBSTITUA O CONTEÚDO DA VARIÁVEL 
            //    'FINAL_GITHUB_URL' PELA URL COMPLETA DO SEU PROJETO (ex: https://SEU-USUARIO.github.io/NOME-DO-REPOSITORIO/).
            const FINAL_GITHUB_URL = "https://SEU-USUARIO.github.io/SEU-REPOSITORIO-AQUI"; 
            
            // 2. URL A SER USADA:
            //    - No ambiente de preview (como este), usamos a URL atual para testar.
            //    - APÓS O DEPLOY no GitHub, MANTENHA SOMENTE A LINHA 'urlToUse = FINAL_GITHUB_URL;'
            
            let urlToUse;
            
            // VERIFICA SE O USUÁRIO FORNECEU UMA URL VÁLIDA NA VARIÁVEL FINAL_GITHUB_URL
            if (FINAL_GITHUB_URL.includes("SEU-USUARIO") || FINAL_GITHUB_URL === "") {
                // Caso ainda não tenha sido configurada a URL final, usa a URL atual (do Preview)
                urlToUse = window.location.href; 
                console.warn("Aviso: FINAL_GITHUB_URL ainda não foi configurada. Usando URL de Preview para o QR Code.");
            } else {
                // Usa a URL final configurada pelo usuário (ideal para deploy)
                urlToUse = FINAL_GITHUB_URL; 
                console.log("Usando FINAL_GITHUB_URL para o QR Code:", urlToUse);
            }
            
            // ====================================================================

            const qrcodeDiv = document.getElementById("qrcode");
            
            if (qrcodeDiv.innerHTML === '') { // Evita regenerar
                new QRCode(qrcodeDiv, {
                    text: urlToUse,
                    width: 160,
                    height: 160,
                    colorDark : "#0f172a",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            }
        }

        // ====================================================================
        // INICIALIZAÇÃO
        // ====================================================================

        /**
         * Inicializa as funcionalidades do app (chamada após o DOM estar pronto).
         */
        function mainAppInit() {
            console.log("Inicialização do App principal (LocalStorage).");
            
            // 1. Inicializa o tema (claro/escuro)
            initTheme();

            // 2. Configura o carregamento do Histórico (LocalStorage)
            setupHistoryListener();

            // 3. Configura a Entrada de Voz
            setupVoiceInput();

            // 4. Configura o QR Code
            generateQRCode();
            
            // 5. Configura o Event Listener principal
            elements.calculateBtn.addEventListener('click', calculateAndPlot);

            // 6. Faz o cálculo inicial com os valores de exemplo
            calculateAndPlot();
        }
        
        // Chamada principal para iniciar a aplicação
        document.addEventListener('DOMContentLoaded', mainAppInit);

    </script>
</body>
</html>